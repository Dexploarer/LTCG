/**
 * Authentication Components
 *
 * Example components for sign-up, sign-in, and wallet display
 */

"use client";

import { useAuthActions } from "@convex-dev/auth/react";
import { useMutation, useQuery } from "convex/react";
import { api } from "@convex/_generated/api";
import { useState } from "react";

/**
 * Sign-up form with automatic Solana wallet creation
 */
export function SignUpForm() {
  const { signIn } = useAuthActions();
  const createProfile = useMutation(api.users.createUserProfileWithWallet);

  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [displayName, setDisplayName] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [success, setSuccess] = useState(false);

  const handleSignUp = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError("");

    try {
      // Step 1: Create auth account
      await signIn("password", {
        email,
        password,
        flow: "signUp",
      });

      // Step 2: Create user profile with Solana wallet
      const result = await createProfile({
        password, // Same password used to encrypt wallet
        displayName,
      });

      setSuccess(true);
      console.log("✅ Account created with Solana wallet:", result);
    } catch (err) {
      setError(err instanceof Error ? err.message : "Sign-up failed");
    } finally {
      setLoading(false);
    }
  };

  if (success) {
    return (
      <div className="success-message">
        <h2>✅ Account Created Successfully!</h2>
        <p>Your non-custodial Solana wallet has been created.</p>
        <p>
          <strong>IMPORTANT:</strong> Backup your password securely - it cannot
          be recovered!
        </p>
      </div>
    );
  }

  return (
    <form onSubmit={handleSignUp}>
      <h2>Sign Up</h2>

      {error && <div className="error">{error}</div>}

      <div>
        <label>Email:</label>
        <input
          type="email"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
          required
        />
      </div>

      <div>
        <label>Password:</label>
        <input
          type="password"
          value={password}
          onChange={(e) => setPassword(e.target.value)}
          required
          minLength={8}
        />
        <small>Will be used to encrypt your Solana wallet</small>
      </div>

      <div>
        <label>Display Name:</label>
        <input
          type="text"
          value={displayName}
          onChange={(e) => setDisplayName(e.target.value)}
        />
      </div>

      <button type="submit" disabled={loading}>
        {loading ? "Creating Account..." : "Sign Up & Generate Wallet"}
      </button>
    </form>
  );
}

/**
 * Sign-in form
 */
export function SignInForm() {
  const { signIn } = useAuthActions();

  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  const handleSignIn = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError("");

    try {
      await signIn("password", {
        email,
        password,
        flow: "signIn",
      });
    } catch (err) {
      setError(err instanceof Error ? err.message : "Sign-in failed");
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSignIn}>
      <h2>Sign In</h2>

      {error && <div className="error">{error}</div>}

      <div>
        <label>Email:</label>
        <input
          type="email"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
          required
        />
      </div>

      <div>
        <label>Password:</label>
        <input
          type="password"
          value={password}
          onChange={(e) => setPassword(e.target.value)}
          required
        />
      </div>

      <button type="submit" disabled={loading}>
        {loading ? "Signing In..." : "Sign In"}
      </button>
    </form>
  );
}

/**
 * Wallet display component (shows user's Solana public key)
 */
export function WalletDisplay() {
  const walletInfo = useQuery(api.users.getSolanaPublicKey);

  if (!walletInfo) {
    return <div>No wallet found. Please create an account.</div>;
  }

  const { publicKey, displayName } = walletInfo;

  return (
    <div className="wallet-display">
      <h3>Your Solana Wallet</h3>
      <p>
        <strong>Name:</strong> {displayName || "Anonymous"}
      </p>
      <p>
        <strong>Public Key:</strong>
        <code>{publicKey}</code>
      </p>
      <button onClick={() => navigator.clipboard.writeText(publicKey)}>
        Copy Address
      </button>
    </div>
  );
}

/**
 * Sign-out button
 */
export function SignOutButton() {
  const { signOut } = useAuthActions();

  return (
    <button onClick={() => signOut()}>
      Sign Out
    </button>
  );
}
